<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HoDMeet - Smart Appointment Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1557682250-33bd709cbe85?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .text-shadow { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .disabled-date { color: #94a3b8; pointer-events: none; }
        .form-input-disabled { background-color: #f3f4f6; cursor: not-allowed; }
        .glass-card { background-color: rgba(0, 0, 0, 0.25); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .glass-input { background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; }
        .glass-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .glass-input:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); }
        .dashboard-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="login-flow-container" class="min-h-screen p-4 flex flex-col items-center justify-center">
        <div id="role-selection-view" class="w-full max-w-md">
            <div class="glass-card rounded-2xl p-8 text-center">
                <img src="component/cc.png" alt="CMRIT Logo" class="h-16 mx-auto mb-6">
                <h1 class="text-3xl font-bold text-white mb-2 text-shadow">Welcome to HoDMeet</h1>
                <p class="text-gray-300 mb-8">Please select your role to begin.</p>
                <div class="space-y-4">
                    <button data-role="Student" class="role-btn w-full p-3 bg-white/80 text-gray-800 font-semibold rounded-lg hover:bg-white transition-colors shadow-md">Login as Student</button>
                    <button data-role="Faculty" class="role-btn w-full p-3 bg-white/80 text-gray-800 font-semibold rounded-lg hover:bg-white transition-colors shadow-md">Login as Faculty</button>
                    <button data-role="HOD" class="role-btn w-full p-3 bg-white/80 text-gray-800 font-semibold rounded-lg hover:bg-white transition-colors shadow-md">Login as HOD</button>
                </div>
                <div class="mt-6 text-center">
                    <button id="show-dev-login-btn" class="text-xs text-gray-300 hover:text-white transition-colors">Dev Admin</button>
                </div>
            </div>
        </div>
        <div id="login-credentials-view" class="hidden w-full max-w-md">
            <div class="glass-card rounded-2xl p-8 text-center relative">
                <button id="back-to-role-btn" class="absolute top-4 left-4 text-white/70 hover:text-white transition-colors flex items-center gap-1 text-sm"><ion-icon name="arrow-back-outline"></ion-icon> Back</button>
                <div class="flex justify-center mb-4"><img src="component/cc.png" alt="CMRIT Logo" class="h-16 mx-auto mb-4"></div>
                <h1 id="login-role-title" class="text-3xl font-bold text-white text-shadow mb-6">Login</h1>
                <div class="space-y-4 my-6">
                    <input id="email-input" type="email" placeholder="Registered Email" class="w-full p-3 rounded-lg glass-input">
                    <input id="password-input" type="password" placeholder="Password" class="w-full p-3 rounded-lg glass-input">
                </div>
                <button id="login-continue" class="w-full p-3 bg-white text-gray-800 font-semibold rounded-lg hover:bg-gray-200 transition-colors shadow-lg"><span>Continue</span></button>
            </div>
        </div>
        <div id="dev-login-view" class="hidden w-full max-w-md">
             <div class="glass-card rounded-2xl p-8 text-center relative">
                 <button id="back-to-role-from-dev-btn" class="absolute top-4 left-4 text-white/70 hover:text-white transition-colors flex items-center gap-1 text-sm"><ion-icon name="arrow-back-outline"></ion-icon> Back</button>
                 <h1 class="text-3xl font-bold text-white text-shadow mb-6">Admin Login</h1>
                 <div class="space-y-4 my-6"><input id="dev-password-input" type="password" placeholder="Admin Password" class="w-full p-3 rounded-lg glass-input"></div>
                 <button id="dev-login-continue" class="w-full p-3 bg-white text-gray-800 font-semibold rounded-lg hover:bg-gray-200 transition-colors shadow-lg"><span>Login</span></button>
             </div>
        </div>
    </div>

    <div id="dev-admin-view" class="hidden">
        <div class="min-h-screen p-4 sm:p-6 md:p-8 flex flex-col items-center">
            <header class="w-full max-w-3xl mb-8 flex items-center justify-between">
                <div><h1 class="text-3xl sm:text-4xl font-bold text-white text-shadow">User Whitelist</h1><p class="text-gray-200 mt-1 text-shadow">Manage registered users</p></div>
                <button class="logout-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold shadow-md">Logout</button>
            </header>
            <main class="w-full max-w-3xl bg-white/70 backdrop-blur-2xl rounded-2xl shadow-2xl shadow-black/20 p-4 sm:p-6 md:p-8 border border-white/20">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Add New User</h2>
                <form id="add-user-form" class="flex flex-col sm:flex-row gap-4 mb-8">
                    <input id="new-user-email" type="email" placeholder="User Email" class="p-2 border rounded-lg flex-grow" required>
                    <select id="new-user-role" class="p-2 border rounded-lg"><option value="student">Student</option><option value="faculty">Faculty</option><option value="hod">HOD</option></select>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Add User</button>
                </form>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Registered Users</h2>
                <div id="user-whitelist" class="space-y-2"></div>
            </main>
        </div>
    </div>

    <div id="main-dashboard-view" class="hidden">
        <div class="min-h-screen p-4 sm:p-6 md:p-8 flex flex-col items-center">
             <header class="w-full max-w-5xl mb-8 flex items-center justify-between">
                 <div class="flex items-center gap-4">
                     <img id="main-dash-user-dp" src="placeholder_dp.png" alt="User DP" class="h-12 w-12 rounded-full border-2 border-white shadow-lg cursor-pointer hover:opacity-90 transition-opacity">
                     <div><p id="main-dash-user-name" class="font-bold text-xl text-white text-shadow">User Name</p><p id="main-dash-user-role" class="text-sm text-gray-300 text-shadow">Role</p></div>
                 </div>
                 <button class="logout-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold shadow-md">Logout</button>
             </header>
            <main class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 gap-8">
                <div id="go-to-scheduler-btn" class="glass-card rounded-2xl p-8 text-center text-white cursor-pointer dashboard-card"><ion-icon name="calendar-outline" class="text-6xl mb-4"></ion-icon><h2 class="text-2xl font-bold">Manage My Schedule</h2><p class="text-gray-300 mt-2">Manage your calendar for students.</p></div>
                <div id="go-to-attendance-btn" class="glass-card rounded-2xl p-8 text-center text-white cursor-pointer dashboard-card"><ion-icon name="checkbox-outline" class="text-6xl mb-4"></ion-icon><h2 class="text-2xl font-bold">Mark Attendance</h2><p class="text-gray-300 mt-2">Record attendance for past meetings.</p></div>
                <div id="book-with-hod-btn" class="hidden md:col-span-2 glass-card rounded-2xl p-8 text-center text-white cursor-pointer dashboard-card"><ion-icon name="person-add-outline" class="text-6xl mb-4"></ion-icon><h2 class="text-2xl font-bold">Book Meeting with HOD</h2><p class="text-gray-300 mt-2">Schedule an appointment on the HOD's calendar.</p></div>
            </main>
        </div>
    </div>

    <div id="scheduler-view" class="hidden">
        <div id="app" class="min-h-screen p-4 sm:p-6 md:p-8 flex flex-col items-center">
             <header class="w-full max-w-5xl mb-4 flex items-center justify-between">
                 <div class="flex items-center gap-4">
                     <img id="scheduler-user-dp" src="placeholder_dp.png" alt="User DP" class="h-12 w-12 rounded-full border-2 border-white shadow-lg cursor-pointer hover:opacity-90 transition-opacity">
                     <div><p id="scheduler-user-name" class="font-bold text-xl text-white text-shadow">User Name</p><p id="scheduler-user-role" class="text-sm text-gray-300 text-shadow">Role</p></div>
                 </div>
                 <button class="logout-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold shadow-md">Logout</button>
             </header>
             <div class="w-full max-w-5xl mb-4 text-center">
                 <button id="back-to-main-dash-btn" class="text-white/80 hover:text-white transition-colors flex items-center gap-1 text-sm mb-2 float-left"><ion-icon name="arrow-back-outline"></ion-icon> Back to Dashboard</button>
                 <h1 id="scheduler-title" class="text-3xl sm:text-4xl font-bold text-white text-shadow inline-block">Meeting Scheduler</h1>
             </div>
            <main class="w-full max-w-5xl bg-white/70 backdrop-blur-2xl rounded-2xl shadow-2xl shadow-black/20 p-4 sm:p-6 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 border border-white/20">
                <div class="lg:col-span-2">
                     <div class="flex items-center justify-between mb-6">
                         <button id="prev-month" class="p-2 rounded-full hover:bg-black/10 transition-colors"><ion-icon name="chevron-back-outline" class="text-2xl text-gray-700"></ion-icon></button>
                         <h2 id="current-month-year" class="text-xl font-semibold text-gray-900"></h2>
                         <button id="next-month" class="p-2 rounded-full hover:bg-black/10 transition-colors"><ion-icon name="chevron-forward-outline" class="text-2xl text-gray-700"></ion-icon></button>
                     </div>
                     <div id="calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                     <div class="mt-6"><button id="import-data-btn" class="w-full flex items-center justify-center gap-3 p-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors shadow-md"><ion-icon name="cloud-upload-outline" class="text-2xl"></ion-icon><span>Import & Schedule Group Meeting</span></button></div>
                </div>
                <div class="lg:col-span-1 border-t lg:border-t-0 lg:border-l border-gray-900/10 lg:pl-8 pt-6 lg:pt-0">
                    <h3 class="text-lg font-semibold mb-1">Appointments</h3><p id="selected-date-display" class="text-sm text-gray-600 mb-4">Select a date to see schedule</p><div id="time-slots" class="max-h-[450px] overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </main>
        </div>
    </div>

     <div id="attendance-view" class="hidden">
        <div class="min-h-screen p-4 sm:p-6 md:p-8 flex flex-col items-center">
             <header class="w-full max-w-5xl mb-4 flex items-center justify-between">
                 <div class="flex items-center gap-4">
                     <img id="attendance-user-dp" src="placeholder_dp.png" alt="User DP" class="h-12 w-12 rounded-full border-2 border-white shadow-lg cursor-pointer hover:opacity-90 transition-opacity">
                     <div><p id="attendance-user-name" class="font-bold text-xl text-white text-shadow">User Name</p><p id="attendance-user-role" class="text-sm text-gray-300 text-shadow">Role</p></div>
                 </div>
                 <button class="logout-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold shadow-md">Logout</button>
             </header>
             <div class="w-full max-w-5xl mb-4 text-center">
                 <button id="back-to-main-dash-from-attendance-btn" class="text-white/80 hover:text-white transition-colors flex items-center gap-1 text-sm mb-2 float-left"><ion-icon name="arrow-back-outline"></ion-icon> Back to Dashboard</button>
                 <h1 class="text-3xl sm:text-4xl font-bold text-white text-shadow inline-block">Mark Attendance</h1>
             </div>
             <main class="w-full max-w-5xl bg-white/70 backdrop-blur-2xl rounded-2xl shadow-2xl shadow-black/20 p-4 sm:p-6 md:p-8 border border-white/20">
                 <div class="flex items-center gap-4 mb-6"><label for="attendance-date-picker" class="font-semibold text-gray-700">Select Date:</label><input type="date" id="attendance-date-picker" class="p-2 border rounded-lg"></div>
                 <div id="attendance-list" class="space-y-3"><p class="text-gray-500 text-center p-4">Select a date to see student list.</p></div>
                  <div class="mt-6 flex justify-end"><button id="save-attendance-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 disabled:bg-gray-400" disabled>Save Attendance</button></div>
             </main>
        </div>
    </div>

    <div id="student-dashboard-view" class="hidden">
        <div class="min-h-screen p-4 sm:p-6 md:p-8 flex flex-col items-center">
            <header class="w-full max-w-5xl mb-8 flex items-center justify-between">
                <div><h1 class="text-3xl sm:text-4xl font-bold text-white text-shadow">My Appointments</h1><p class="text-gray-200 mt-1 text-shadow">Your scheduled sessions</p></div>
                <div class="flex items-center gap-4">
                     <div class="text-right"><p id="student-user-name" class="font-semibold text-white text-shadow">Student Name</p><p id="student-user-role" class="text-sm text-gray-300 text-shadow">Student</p></div>
                    <img id="student-user-dp" src="placeholder_dp.png" alt="User DP" class="h-12 w-12 rounded-full border-2 border-white shadow-lg cursor-pointer hover:opacity-90 transition-opacity">
                    <button class="logout-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold shadow-md">Logout</button>
                </div>
            </header>
            <main class="w-full max-w-5xl bg-white/70 backdrop-blur-2xl rounded-2xl shadow-2xl shadow-black/20 p-4 sm:p-6 md:p-8 border border-white/20">
                <div class="mb-6 flex flex-col sm:flex-row justify-end gap-3">
                    <button id="book-with-faculty-btn-student" class="px-5 py-2 bg-white text-indigo-600 font-semibold rounded-lg hover:bg-gray-100 transition-colors shadow-md flex items-center justify-center gap-2"><ion-icon name="person-add-outline" class="text-xl"></ion-icon> Book with Faculty</button>
                    <button id="book-with-hod-btn-student" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-md flex items-center justify-center gap-2"><ion-icon name="school-outline" class="text-xl"></ion-icon> Book with HOD</button>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Upcoming Sessions</h2>
                <div id="appointment-list" class="space-y-4"></div>
            </main>
            <footer class="w-full max-w-5xl mt-8 text-center"><p class="text-gray-300 text-sm text-shadow">&copy; 2025 HoDMeet University. All Rights Reserved.</p></footer>
        </div>
    </div>

    <div id="modal-shell" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden transition-opacity duration-300 z-50">
        <div id="modal-content-area" class="bg-white/90 backdrop-blur-xl border border-white/20 rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300"></div>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 translate-y-[-20px] transition-all duration-300 flex items-center gap-3 z-50">
        <ion-icon id="toast-icon" name="checkmark-circle" class="text-2xl"></ion-icon>
        <span id="toast-message">Success!</span>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- VIEWS ---
    const loginFlowContainer = document.getElementById('login-flow-container');
    const roleSelectionView = document.getElementById('role-selection-view');
    const loginCredentialsView = document.getElementById('login-credentials-view');
    const mainDashboardView = document.getElementById('main-dashboard-view');
    const schedulerView = document.getElementById('scheduler-view');
    const attendanceView = document.getElementById('attendance-view');
    const studentDashboardView = document.getElementById('student-dashboard-view');
    const devLoginView = document.getElementById('dev-login-view');
    const devAdminView = document.getElementById('dev-admin-view');

    // --- LOGIN BUTTONS ---
    const roleButtons = roleSelectionView.querySelectorAll('.role-btn');
    const backToRoleBtn = document.getElementById('back-to-role-btn');
    const loginContinueBtn = document.getElementById('login-continue');
    const loginRoleTitle = document.getElementById('login-role-title');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');

    // --- DEV ADMIN BUTTONS ---
    const showDevLoginBtn = document.getElementById('show-dev-login-btn');
    const backToRoleFromDevBtn = document.getElementById('back-to-role-from-dev-btn');
    const devPasswordInput = document.getElementById('dev-password-input');
    const devLoginContinueBtn = document.getElementById('dev-login-continue');
    const addUserForm = document.getElementById('add-user-form');
    const newUserEmail = document.getElementById('new-user-email');
    const newUserRole = document.getElementById('new-user-role');
    const userWhitelist = document.getElementById('user-whitelist');

    // --- MAIN DASHBOARD (HOD/FACULTY) ---
    const goToSchedulerBtn = document.getElementById('go-to-scheduler-btn');
    const goToAttendanceBtn = document.getElementById('go-to-attendance-btn');
    const mainDashUserName = document.getElementById('main-dash-user-name');
    const mainDashUserRole = document.getElementById('main-dash-user-role');
    const mainDashUserDP = document.getElementById('main-dash-user-dp');
    const backToMainDashBtn = document.getElementById('back-to-main-dash-btn');
    const backToMainDashFromAttendanceBtn = document.getElementById('back-to-main-dash-from-attendance-btn');
    const bookWithHodBtn = document.getElementById('book-with-hod-btn');

    // --- LOGOUT ---
    const allLogoutBtns = document.querySelectorAll('.logout-btn');

    // --- SCHEDULER DOM ELEMENTS ---
    const schedulerTitle = document.getElementById('scheduler-title');
    const currentMonthYear = document.getElementById('current-month-year');
    const calendarGrid = document.getElementById('calendar-grid');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const selectedDateDisplay = document.getElementById('selected-date-display');
    const timeSlotsContainer = document.getElementById('time-slots');
    const schedulerUserName = document.getElementById('scheduler-user-name');
    const schedulerUserRole = document.getElementById('scheduler-user-role');
    const importDataBtn = document.getElementById('import-data-btn');
    const schedulerUserDP = document.getElementById('scheduler-user-dp');

    // --- ATTENDANCE VIEW ELEMENTS ---
    const attendanceDatePicker = document.getElementById('attendance-date-picker');
    const attendanceList = document.getElementById('attendance-list');
    const saveAttendanceBtn = document.getElementById('save-attendance-btn');
    const attendanceUserName = document.getElementById('attendance-user-name');
    const attendanceUserRole = document.getElementById('attendance-user-role');
    const attendanceUserDP = document.getElementById('attendance-user-dp');

    // --- STUDENT DASHBOARD ELEMENTS ---
    const appointmentList = document.getElementById('appointment-list');
    const studentUserName = document.getElementById('student-user-name');
    const studentUserRole = document.getElementById('student-user-role');
    const studentUserDP = document.getElementById('student-user-dp');
    const bookWithHodBtnStudent = document.getElementById('book-with-hod-btn-student');
    const bookWithFacultyBtnStudent = document.getElementById('book-with-faculty-btn-student');

    // --- MODAL & TOAST ELEMENTS ---
    const modalShell = document.getElementById('modal-shell');
    const modalContentArea = document.getElementById('modal-content-area');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');

    // --- STATE ---
    let currentDate = new Date();
    let selectedDate = new Date();
    let currentUserRole = null; // Set during login based on backend response ('student', 'faculty', 'hod')
    let loggedInUserData = null; // Store user details { id, name, email, role, dpUrl } from backend
    let viewingCalendarFor = 'hod';
    let bookingModalDate = new Date();
    let bookingModalSelectedDate = new Date();

    // --- HELPER FUNCTIONS ---
    const toYYYYMMDD = (date) => date.toISOString().split('T')[0];
    const toHHMM = (date) => date.toTimeString().substring(0, 5);

    // --- DATA STORE (Placeholders - Real data comes via API) ---
    let hodCalendar = {}; // Will be populated by API later
    let facultyCalendar = {}; // Will be populated by API later
    let currentUserAppointments = []; // Populated by API on login/dashboard view

     // --- Availability (Keep definitions for modals) ---
     const hodAvailability = {
        1: { start: '09:00', end: '17:00' }, 2: { start: '09:00', end: '17:00' },
        3: { start: '09:00', end: '13:00' }, 4: { start: '09:00', end: '17:00' },
        5: { start: '13:00', end: '17:00' },
    };
    const facultyAvailability = {
        1: { start: '10:00', end: '16:00' }, 2: { start: '10:00', end: '16:00' },
        3: { start: '09:00', end: '12:00' }, 4: { start: '10:00', end: '16:00' },
        5: { start: '13:00', end: '16:00' },
    };
    const appointmentDuration = 30;

    // --- VIEW MANAGEMENT ---
    const hideAllViews = () => {
        [loginFlowContainer, mainDashboardView, schedulerView, studentDashboardView, attendanceView, devAdminView].forEach(v => v.classList.add('hidden'));
    }

    const setupAndShowView = (role) => { // Role now comes from loggedInUserData.role ('student', 'faculty', 'hod')
        hideAllViews();
        selectedDate = new Date();
        // currentUserRole is already set during handleLogin

        if (!loggedInUserData) {
            console.error("User data not available for dashboard setup. Redirecting to login.");
            showLogin(); // Safety check
            return;
        }

        // Appointments are now fetched specifically when needed (e.g., in populateAndRenderAppointments)

        if (role === 'student') {
            studentUserName.textContent = loggedInUserData.name;
            studentUserRole.textContent = 'Student';
            studentUserDP.src = loggedInUserData.dpUrl || 'https://placehold.co/60x60/E2E8F0/4A5568?text=DP';
            studentDashboardView.classList.remove('hidden');
            populateAndRenderAppointments(); // Call the fetch & render function
        } else { // Faculty or HOD
            showMainDashboard(role);
            // If faculty needs to see their personal list on the main dash, add UI and call populateAndRenderAppointments here
        }
    };

    const showMainDashboard = (role) => {
        hideAllViews();
         if (!loggedInUserData) { // Safety check
             showLogin(); return;
         }
        mainDashUserName.textContent = loggedInUserData.name;
        mainDashUserRole.textContent = role === 'hod' ? 'Head of Department' : 'Faculty';
        mainDashUserDP.src = loggedInUserData.dpUrl || 'https://placehold.co/60x60/E2E8F0/4A5568?text=DP';

        bookWithHodBtn.classList.toggle('hidden', role !== 'faculty'); // Show only for faculty
        mainDashboardView.classList.remove('hidden');
    }

    const showScheduler = (calendarOwnerRole) => {
        hideAllViews();
        viewingCalendarFor = calendarOwnerRole;
         if (!loggedInUserData) { showLogin(); return; } // Safety check

        schedulerUserRole.textContent = currentUserRole === 'hod' ? 'Head of Department' : 'Faculty';
        schedulerUserName.textContent = loggedInUserData.name;
        schedulerUserDP.src = loggedInUserData.dpUrl || 'https://placehold.co/60x60/E2E8F0/4A5568?text=DP';
        schedulerTitle.textContent = (calendarOwnerRole === 'hod') ? "HOD Meeting Scheduler" : "My Meeting Scheduler";
        schedulerView.classList.remove('hidden');

        // TODO: Replace renderCalendar and updateDateDisplayAndSlots with API calls to fetch calendar data for 'calendarOwnerRole'
        console.warn(`Scheduler view for ${calendarOwnerRole} still uses dummy rendering. Replace with API calls.`);
        renderCalendar(); // Call dummy render for now
        updateDateDisplayAndSlots(); // Call dummy render for now
    }

    const showAttendance = () => {
         hideAllViews();
         if (!loggedInUserData) { showLogin(); return; } // Safety check

        attendanceUserRole.textContent = currentUserRole === 'hod' ? 'Head of Department' : 'Faculty';
        attendanceUserName.textContent = loggedInUserData.name;
        attendanceUserDP.src = loggedInUserData.dpUrl || 'https://placehold.co/60x60/E2E8F0/4A5568?text=DP';
        attendanceView.classList.remove('hidden');
        attendanceDatePicker.value = toYYYYMMDD(new Date());

        // TODO: Replace renderAttendanceList with API calls to fetch attendance data for the selected date and calendar owner
        console.warn("Attendance view still uses dummy rendering. Replace with API calls.");
        renderAttendanceList(); // Call dummy render for now
    }

    const showLogin = () => {
        hideAllViews();
        currentUserRole = null;
        loggedInUserData = null; // Clear user data
        loginCredentialsView.classList.add('hidden');
        devLoginView.classList.add('hidden');
        roleSelectionView.classList.remove('hidden');
        loginFlowContainer.classList.remove('hidden');
    };

    // --- Dev Admin Functions --- (Placeholders)
    const showDevLogin = () => { roleSelectionView.classList.add('hidden'); devLoginView.classList.remove('hidden'); };
    const showDevAdmin = () => { hideAllViews(); loginFlowContainer.classList.add('hidden'); devAdminView.classList.remove('hidden'); renderUserWhitelist(); };
    const renderUserWhitelist = () => { userWhitelist.innerHTML = '<p>Admin user list (backend needed)</p>'; };
    const handleAddUser = (e) => { e.preventDefault(); showToast('Add user functionality requires backend.', 'info');};

    // --- STUDENT/FACULTY DASHBOARD ---
    const populateAndRenderAppointments = async () => {
        console.log("Fetching appointments from backend...");
        appointmentList.innerHTML = '<p class="text-gray-500 text-center p-4">Loading appointments...</p>';
        currentUserAppointments = []; // Clear previous

        try {
            // UPDATED URL
            const response = await fetch('http://127.0.0.1:5001/api/appointments/my', {
                method: 'GET',
                credentials: 'include', // Crucial for sending session cookie
                headers: {}
            });

            if (!response.ok) {
                 if (response.status === 401) {
                     showToast('Session expired or invalid. Please log in again.', 'error');
                     showLogin(); return;
                 } else {
                     const errData = await response.json().catch(() => ({ message: 'Failed to fetch appointments and parse error.' }));
                     throw new Error(errData.message || `HTTP error! status: ${response.status}`);
                 }
             }

            currentUserAppointments = await response.json();
            console.log("Fetched appointments:", currentUserAppointments);

        } catch (error) {
            console.error('Fetch appointments error:', error);
            showToast(error.message || 'Could not fetch appointments.', 'error');
            // currentUserAppointments remains empty
        }

        // --- Now Render ---
        appointmentList.innerHTML = '';
        if (currentUserAppointments.length === 0) {
            appointmentList.innerHTML = `<p class="text-gray-500 text-center">You have no upcoming appointments.</p>`;
            return;
        }

        currentUserAppointments.sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));

        currentUserAppointments.forEach(appt => {
            const isHighPriority = appt.with.includes('(HOD)');
            const apptEl = document.createElement('div');
            apptEl.className = `bg-white/60 p-4 rounded-lg shadow-sm border ${isHighPriority ? 'border-l-4 border-l-red-500' : 'border-gray-200/80'} flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4`;
            const appointmentDate = new Date(appt.date + 'T' + appt.time);
            let locationInfo = '';
            if (appt.gmeet) { locationInfo = `<div class="mt-2"><a href="${appt.gmeet}" target="_blank" class="text-sm inline-flex items-center gap-2 text-blue-600 font-semibold hover:underline"><ion-icon name="videocam-outline"></ion-icon> Join Google Meet</a></div>`;}
            else if (appt.venue) { locationInfo = `<div class="mt-2"><p class="text-sm inline-flex items-center gap-2 text-gray-700 font-semibold"><ion-icon name="location-outline"></ion-icon> Venue: ${appt.venue}</p></div>`; }
            const priorityBadge = isHighPriority ? `<span class="ml-2 text-xs font-bold uppercase bg-red-100 text-red-700 px-2 py-1 rounded-full">High Priority</span>` : '';

            apptEl.innerHTML = `
                <div class="flex-grow">
                    <p class="font-bold text-lg text-indigo-800 flex items-center">${appt.reason} ${priorityBadge}</p>
                    <p class="text-sm text-gray-700">With: <span class="font-semibold">${appt.with}</span></p>
                    <p class="text-sm text-gray-600 mt-2 italic">"${appt.description}"</p>
                    ${appt.notice ? `<div class="mt-2 p-2 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 text-sm rounded-r-md"><strong>Notice:</strong> ${appt.notice}</div>` : ''}
                    ${locationInfo}
                </div>
                <div class="text-left sm:text-right text-sm bg-gray-100 px-3 py-2 rounded-lg self-start sm:self-center flex-shrink-0">
                    <p class="font-semibold text-gray-800">${appointmentDate.toLocaleDateString('default', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                    <p class="text-gray-600">${appt.time}</p>
                </div>`;
            appointmentList.appendChild(apptEl);
        });
    };

    // --- ATTENDANCE FUNCTIONS --- (Dummy rendering)
    const renderAttendanceList = () => { attendanceList.innerHTML = '<p class="text-gray-500 text-center p-4">Select date (Attendance backend needed)</p>'; saveAttendanceBtn.disabled = true; };

    // --- SCHEDULER FUNCTIONS --- (Dummy rendering)
    const renderCalendar = () => { calendarGrid.innerHTML = '<div>Calendar rendering (backend needed)</div>'; currentMonthYear.textContent = 'Month Year';};
    const generateTimeSlots = (date) => { timeSlotsContainer.innerHTML = '<div>Time slot rendering (backend needed)</div>'; };
    const updateDateDisplayAndSlots = () => { selectedDateDisplay.textContent = `For ${selectedDate.toLocaleDateString()}`; generateTimeSlots(selectedDate); };
    const handleDateClick = (e) => { const target = e.target.closest('button[data-date]'); if (!target || target.classList.contains('disabled-date')) return; selectedDate = new Date(target.dataset.date); renderCalendar(); updateDateDisplayAndSlots(); }; // Basic selection logic kept

    // --- MODAL & TOAST LOGIC --- (Keep full definitions)
    const showModal = (content, callback) => { modalContentArea.innerHTML = content; modalShell.classList.remove('hidden'); setTimeout(() => { modalShell.classList.add('opacity-100'); modalContentArea.classList.add('scale-100');}, 10); const closeModalButton = modalShell.querySelector('.close-modal-btn'); if (closeModalButton) { closeModalButton.addEventListener('click', hideModal); } if (callback) callback(); };
    const hideModal = () => { modalShell.classList.remove('opacity-100'); modalContentArea.classList.remove('scale-100'); setTimeout(() => { modalShell.classList.add('hidden'); modalContentArea.innerHTML = ''; }, 300); };
    const showEditProfileModal = () => { /* ... keep full implementation ... */ };
    const showNotifyModal = (date, time, appointment) => { /* ... keep full implementation ... */ };
    const showCancelModal = (date, time, appointment) => { /* ... keep full implementation ... */ };
    const showManualBookModal = (date, time) => { /* ... keep full implementation ... */ };
    const handleFileUploadAndShowScheduler = (fileInputId, attendeeRole, targetCalendarRole) => { /* ... keep full implementation ... */ };
    const showBulkScheduleModal = (contacts, attendeeRole, targetCalendarRole) => { /* ... keep full implementation ... */ };
    const showImportModal = () => { /* ... keep full implementation ... */ };
    const showBookingModal = (targetRole) => { /* ... keep full implementation ... */ };
    const renderBookingCalendar = (targetRole) => { /* ... keep full implementation ... */ };
    const handleBookingDateClick = (e, targetRole) => { /* ... keep full implementation ... */ };
    const generateAvailableTimeSlots = (date, targetRole) => { /* ... keep full implementation ... */ };
    const showBookingConfirmationModal = (date, time, targetRole) => { /* ... keep full implementation ... */ };
    const showToast = (message, type = 'success') => { toast.classList.remove('bg-green-500', 'bg-blue-500', 'bg-red-500'); toastIcon.removeAttribute('name'); if (type === 'success') { toast.classList.add('bg-green-500'); toastIcon.setAttribute('name', 'checkmark-circle'); } else if (type === 'info') { toast.classList.add('bg-blue-500'); toastIcon.setAttribute('name', 'information-circle'); } else if (type === 'error') { toast.classList.add('bg-red-500'); toastIcon.setAttribute('name', 'alert-circle'); } toastMessage.textContent = message; toast.classList.add('opacity-100', 'translate-y-0'); setTimeout(() => { toast.classList.remove('opacity-100', 'translate-y-0'); }, 4000); };

    // --- LOGIN LOGIC ---
    async function handleLogin() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        let roleSelected = document.getElementById('login-role-title').textContent.split(' ')[0];
        if (!email || !password || !roleSelected || !['Student', 'Faculty', 'HOD'].includes(roleSelected)) { showToast('Please enter email, password, and ensure a role was selected.', 'error'); if (!roleSelected || !['Student', 'Faculty', 'HOD'].includes(roleSelected)) { loginCredentialsView.classList.add('hidden'); roleSelectionView.classList.remove('hidden'); } return; }
        console.log(`Attempting login for role: ${roleSelected} with email: ${email}`);
        try {
            // UPDATED URL
            const response = await fetch('http://127.0.0.1:5001/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ email, password }), });
            const data = await response.json();
            if (!response.ok) { console.error("Login failed:", data.message); showToast(data.message || 'Login failed.', 'error'); passwordInput.value = '';
            } else {
                 const backendRole = data.user.role;
                 if (backendRole !== roleSelected.toLowerCase()) { console.warn(`Role mismatch: Selected ${roleSelected}, Backend returned ${backendRole}`); showToast(`Login failed: Your account role (${backendRole}) doesn't match the selected login type (${roleSelected}).`, 'error'); passwordInput.value = ''; return; }
                 console.log('Login successful:', data.user); showToast(data.message || 'Login successful!');
                 currentUserRole = data.user.role; loggedInUserData = data.user;
                 emailInput.value = ''; passwordInput.value = '';
                 // --- NEW: Add small delay before showing dashboard ---
                 setTimeout(() => {
                    setupAndShowView(loggedInUserData.role);
                 }, 100); // 100 milliseconds delay
                 // --- END NEW ---
            }
        } catch (error) { console.error('Network or fetch error during login:', error); showToast('Cannot connect to server. Please try again later.', 'error'); }
    }
    loginContinueBtn.addEventListener('click', handleLogin);
    // --- END LOGIN LOGIC ---


    // --- EVENT LISTENERS ---
    roleButtons.forEach(button => { button.addEventListener('click', () => { const role = button.dataset.role; loginRoleTitle.textContent = `${role} Login`; roleSelectionView.classList.add('hidden'); loginCredentialsView.classList.remove('hidden'); }); });
    backToRoleBtn.addEventListener('click', () => { loginCredentialsView.classList.add('hidden'); roleSelectionView.classList.remove('hidden'); });
    showDevLoginBtn.addEventListener('click', showDevLogin);
    backToRoleFromDevBtn.addEventListener('click', showLogin);
    devLoginContinueBtn.addEventListener('click', () => { if (devPasswordInput.value === 'admin123') { showDevAdmin(); devPasswordInput.value = ''; } else { showToast('Incorrect admin password.', 'error'); } });
    addUserForm.addEventListener('submit', handleAddUser);
    goToSchedulerBtn.addEventListener('click', () => { if (currentUserRole === 'hod') { showScheduler('hod'); } else if (currentUserRole === 'faculty') { showScheduler('faculty'); } });
    goToAttendanceBtn.addEventListener('click', showAttendance);
    bookWithHodBtn.addEventListener('click', () => showBookingModal('hod'));
    backToMainDashBtn.addEventListener('click', () => showMainDashboard(currentUserRole));
    backToMainDashFromAttendanceBtn.addEventListener('click', () => showMainDashboard(currentUserRole));
    importDataBtn.addEventListener('click', showImportModal);
    [studentUserDP, schedulerUserDP, mainDashUserDP, attendanceUserDP].forEach(dp => { dp.addEventListener('click', showEditProfileModal); });
    prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
    nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
    calendarGrid.addEventListener('click', handleDateClick);
    attendanceDatePicker.addEventListener('change', renderAttendanceList);
    saveAttendanceBtn.addEventListener('click', () => { showToast('Attendance saved successfully!'); });
    bookWithHodBtnStudent.addEventListener('click', () => showBookingModal('hod'));
    bookWithFacultyBtnStudent.addEventListener('click', () => showBookingModal('faculty'));

     // --- Logout Listener ---
     allLogoutBtns.forEach(btn => {
         btn.addEventListener('click', async () => {
             console.log("Logout button clicked");
             try {
                 // UPDATED URL
                 const response = await fetch('http://127.0.0.1:5001/api/auth/logout', { method: 'POST', credentials: 'include' });
                 const data = await response.json();
                 if (response.ok) { showToast(data.message || "Logged out successfully."); showLogin();
                 } else { showToast(data.message || "Logout failed.", 'error'); }
             } catch (error) { console.error("Logout fetch error:", error); showToast("Error during logout.", 'error'); showLogin(); }
         });
     });
    // --- End Logout Listener ---


    // --- INITIALIZATION ---
     async function checkLoginStatus() {
         try {
             // UPDATED URL
             const response = await fetch('http://127.0.0.1:5001/api/auth/status', { credentials: 'include' });
             if (!response.ok) { console.warn("Status check failed, assuming logged out."); showLogin(); return; }
             const data = await response.json();
             if (data.isAuthenticated && data.user) {
                 console.log("User is already logged in:", data.user);
                 loggedInUserData = data.user; currentUserRole = data.user.role;
                 setupAndShowView(currentUserRole);
             } else { console.log("User is not logged in."); showLogin(); }
         } catch (error) {
             console.error("Error checking login status:", error);
             showToast("Could not verify login status.", 'error'); showLogin();
         }
     }
     checkLoginStatus();
    // --- END INITIALIZATION ---
});
</script>

</body>
</html>